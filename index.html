<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota CRM | V23 (Edição & Fixados)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3; --primary-light: #e0e7ff;
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-sidebar: #0f172a;
            --text-main: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
            --success-light: #d1fae5; --danger-light: #fee2e2; --warning-light: #fef3c7;
            --star: #8b5cf6; --alert: #ef4444;
            --table-hover: #f8fafc; --input-bg: transparent; --chip-bg: #eff6ff; --chip-text: #1e40af;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 16px;
        }

        body.dark-mode {
            --primary: #6366f1; --primary-dark: #818cf8; --primary-light: rgba(99, 102, 241, 0.15);
            --bg-body: #020617; --bg-card: #0f172a; --bg-sidebar: #020617;
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #1e293b;
            --success: #10b981; --danger: #f87171; --warning: #fbbf24; 
            --success-light: rgba(16, 185, 129, 0.15); --danger-light: rgba(239, 68, 68, 0.15); --warning-light: rgba(245, 158, 11, 0.15);
            --table-hover: #1e293b; --input-bg: transparent; --chip-bg: #1e293b; --chip-text: #c7d2fe;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: background-color 0.3s, color 0.3s; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* TELA DE LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-sidebar); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        .login-box { background: var(--bg-card); padding: 40px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 100%; max-width: 400px; text-align: center; }
        .login-box h2 { margin-top: 0; color: var(--text-main); font-weight: 800; font-size: 1.8rem; margin-bottom: 8px; }
        .login-box p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px; }
        .login-input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size: 1rem; font-family: inherit; background: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        .btn-login { width: 100%; padding: 14px; font-size: 1.1rem; border-radius: 10px; margin-top: 10px; }
        .error-msg { color: var(--danger); font-size: 0.85rem; font-weight: 600; margin-top: 15px; display: none; }
        
        #appContainer { display: none; width: 100%; height: 100%; } 

        /* Layout CRM */
        .sidebar { width: 280px; min-width: 280px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; padding: 25px; z-index: 20; border-right: 1px solid rgba(255,255,255,0.05); }
        .brand { font-size: 1.5rem; font-weight: 800; margin-bottom: 30px; color: #818cf8; display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px;}
        .user-panel { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); padding: 20px; border-radius: 16px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05); }
        .user-panel label { font-size:0.7rem; color:#94a3b8; display: block; margin-bottom: 8px; font-weight: 700; letter-spacing: 0.5px;}
        .user-select { width: 100%; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1); padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; font-size: 0.85rem; font-family: inherit; transition: 0.2s;}
        .user-select:hover, .user-select:focus { border-color: var(--primary); background: rgba(0,0,0,0.4);}
        .user-select option { background: #0f172a; color: white; }
        
        .nav-item { padding: 12px 16px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; color: #94a3b8; font-weight: 600; font-size: 0.95rem; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); transform: translateX(4px);}
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); transform: translateX(4px);}
        .nav-theme { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; border-radius: 0;}

        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;}
        .header { background: var(--bg-body); padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .view-section { display: none; padding: 10px 30px 30px; overflow-y: auto; flex: 1; }
        .view-section.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Tabela */
        .table-container { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); overflow-x: auto; overflow-y: auto; max-height: calc(100vh - 120px); box-shadow: var(--shadow-lg); transition: 0.3s;}
        table { width: 100%; min-width: 1950px; border-collapse: separate; border-spacing: 0; }
        th { background: var(--bg-card); padding: 16px 12px; text-align: left; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 2; backdrop-filter: blur(5px); white-space: nowrap;}
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 0.9rem; font-weight: 500; transition: background 0.2s;}
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: var(--table-hover); }
        
        .col-mkp { min-width: 160px; } .col-cliente { min-width: 200px; } .col-analista { min-width: 170px; } .col-consultor { min-width: 170px; } .col-verba { min-width: 200px; }
        
        .smart-input { width: 100%; padding: 8px 10px; border: 1px solid transparent; border-radius: 8px; background: transparent; color: var(--text-main); transition: all 0.2s ease; font-family: inherit; font-size: 0.9rem; font-weight: 600;}
        .smart-input:hover { background: var(--table-hover); border-color: var(--border); }
        .smart-input:focus { background: var(--bg-card); border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .smart-input option { background: var(--bg-card); color: var(--text-main); }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; font-size:0.95rem; background: var(--bg-body); color: var(--text-main); font-family: inherit; transition: 0.2s;}
        
        .usage-badge { font-weight: 700; font-size: 0.85rem; padding: 6px 10px; border-radius: 8px; white-space: nowrap; display: inline-block;}
        .text-red { color: var(--danger); background: var(--danger-light); } 
        .text-green { color: var(--success); background: var(--success-light); } 
        .text-orange { color: var(--warning); background: var(--warning-light); }
        .text-primary-badge { color: var(--primary); background: var(--primary-light); }
        
        .status-badge { padding: 6px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-block; width: 100%; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;}
        .bg-subindo { background: var(--success-light); color: var(--success); } 
        .bg-caindo { background: var(--danger-light); color: var(--danger); } 
        .bg-plato { background: var(--bg-body); color: var(--text-muted); }

        .btn { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; font-size: 0.9rem; font-family: inherit; white-space: nowrap;}
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(79, 70, 229, 0.3); }
        .btn-outline { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--table-hover); border-color: var(--text-muted); }
        .btn-danger { background: var(--danger-light); color: var(--danger); }
        .btn-icon { padding: 8px; border-radius: 8px; }
        
        /* BI, Configs & Modal */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
        .kpi-card { background: var(--bg-card); padding: 24px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); transition: transform 0.2s; position: relative;}
        .kpi-title { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}
        .kpi-value { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-top: 8px; letter-spacing: -0.5px;}
        .mom-indicator { font-size: 0.85rem; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; margin-top: 12px;}
        .mom-up { background: var(--success-light); color: var(--success); } .mom-down { background: var(--danger-light); color: var(--danger); }
        .charts-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px; }
        .chart-box { background: var(--bg-card); padding: 24px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
        .matrix-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .matrix-quad { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); min-height: 160px; box-shadow: var(--shadow-sm);}
        .matrix-title { font-size: 0.9rem; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 10px;}
        .client-tag { background: var(--bg-body); padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; display: flex; justify-content: space-between; border: 1px solid var(--border);}
        .tag-estrela { border-left: 4px solid var(--star); } .tag-aposta { border-left: 4px solid var(--primary); } .tag-gargalo { border-left: 4px solid var(--warning); } .tag-alerta { border-left: 4px solid var(--alert); }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;}
        .settings-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm);}

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s;}
        .modal-overlay.show { opacity: 1; }
        .modal { background: var(--bg-card); width: 700px; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);}
        .modal-overlay.show .modal { transform: scale(1); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); z-index: 2;}
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; background: var(--bg-body); }
        .template-area { background: var(--bg-card); padding: 15px 25px; border-bottom: 1px solid var(--border); }
        .chip-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 8px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .chip:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); transform: translateY(-2px); }
        .chip-add { background: transparent; border: 1px dashed var(--text-muted); color: var(--text-muted); }
        
        .log-entry { padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: var(--shadow-sm); transition: 0.3s; }
        .log-action-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .log-action-btn:hover { background: rgba(0,0,0,0.05); }

        .modal-footer { padding: 20px 25px; border-top: 1px solid var(--border); display: flex; gap: 12px; background: var(--bg-card); }
        
        .sync-indicator { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 8px 16px; border-radius: 30px; font-size: 0.8rem; font-weight: 700; display: none; align-items: center; gap: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div style="font-size: 2.5rem; font-weight: 800; color: #818cf8; margin-bottom: 30px;"><i class="fas fa-layer-group"></i> ROTA CRM</div>
        <div class="login-box">
            <h2>Acesso Restrito</h2>
            <p>Entre com suas credenciais para continuar</p>
            <input type="email" id="emailInput" class="login-input" placeholder="E-mail" autocomplete="email">
            <input type="password" id="passwordInput" class="login-input" placeholder="Senha" autocomplete="current-password">
            <button class="btn btn-primary btn-login" id="btnLogin" onclick="realizarLogin()">Entrar</button>
            <div id="loginError" class="error-msg">Usuário ou senha inválidos.</div>
        </div>
    </div>

    <div id="appContainer">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-layer-group"></i> Rota CRM</div>
            
            <div class="user-panel">
                <label><i class="fas fa-filter"></i> FILTRAR VISÃO</label>
                <select id="clientFilter" class="user-select" onchange="window.renderAll()">
                    <option value="Todos">Todos os Clientes</option>
                </select>
                <select id="analystFilter" class="user-select" onchange="window.renderAll()">
                    <option value="Todos">Todos os Analistas</option>
                </select>
                <select id="consultantFilter" class="user-select" onchange="window.renderAll()" style="margin-bottom:0;">
                    <option value="Todos">Todos os Consultores</option>
                </select>
            </div>

            <nav>
                <div class="nav-item active" onclick="window.switchTab('dashboard', this)"><i class="fas fa-table"></i> Dashboard</div>
                <div class="nav-item" onclick="window.switchTab('reports', this)"><i class="fas fa-chart-pie"></i> Inteligência & BI</div>
                <div class="nav-item" onclick="window.switchTab('settings', this)"><i class="fas fa-sliders-h"></i> Configurações</div>
                
                <div class="nav-item nav-theme" onclick="window.toggleTheme()" id="btnTheme">
                    <i class="fas fa-moon"></i> Tema Escuro
                </div>
                <div class="nav-item" style="color: #f87171; border-top: 1px solid rgba(255,255,255,0.05); border-radius:0; margin-top:5px;" onclick="window.fazerLogout()">
                    <i class="fas fa-sign-out-alt"></i> Sair do Sistema
                </div>
            </nav>
        </aside>

        <main class="main">
            <header class="header">
                <div>
                    <h1 style="margin:0; font-size:1.4rem; font-weight:800; color:var(--text-main);" id="pageTitle">Visão Geral</h1>
                    <div style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-top:4px;" id="pacingDisplay"></div>
                </div>
                <div id="headerActions"></div>
            </header>

            <div id="view-dashboard" class="view-section active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-mkp">Marketplace</th>
                                <th class="col-cliente">Cliente</th>
                                <th class="col-analista">Analista</th>
                                <th class="col-consultor">Consultor</th>
                                <th class="col-verba">Verba Autorizada</th>
                                <th style="min-width: 130px;">Gasto Atual</th>
                                <th style="min-width: 130px;">Rec. ADS</th>
                                <th style="min-width: 100px; text-align:center;">Meta</th>
                                <th style="min-width: 100px; text-align:center;">ACOS</th>
                                <th style="min-width: 110px; text-align:center;">Pacing</th>
                                <th style="min-width: 110px; text-align:center;">Evol.</th>
                                <th style="min-width: 120px; text-align:center;">Status</th>
                                <th style="min-width: 100px; text-align:right;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-reports" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2 style="margin:0; font-size:1.5rem; display:flex; align-items:center; gap:10px;"><i class="fas fa-bolt" style="color:var(--warning)"></i> Painel de Desempenho</h2>
                    <span id="biFilterWarning" style="color:var(--warning); background:var(--warning-light); padding:6px 14px; border-radius:20px; font-size:0.85rem; font-weight:700; display:none;">
                        <i class="fas fa-filter"></i> Dados Filtrados Exibidos
                    </span>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">Gasto Atual</div><div class="kpi-value" id="kpiGasto">R$ 0</div><div id="momGasto"></div></div>
                    <div class="kpi-card"><div class="kpi-title">Receita Gerada</div><div class="kpi-value" id="kpiReceita">R$ 0</div><div id="momReceita"></div></div>
                    <div class="kpi-card"><div class="kpi-title">ACOS Médio</div><div class="kpi-value" id="kpiAcos" style="color:var(--primary)">0.0%</div><div id="momAcos"></div></div>
                    <div class="kpi-card" style="background:var(--primary); color:white; border:none;"><div class="kpi-title" style="color:rgba(255,255,255,0.8)">Projeção de Fechamento</div><div class="kpi-value" id="kpiProjReceita" style="color:white;">R$ 0</div><div style="font-size:0.75rem; color:rgba(255,255,255,0.6); margin-top:12px; font-weight:600;">Baseado no ritmo diário atual</div></div>
                </div>
                <div class="card" style="padding:24px; border-radius:var(--radius);">
                    <h3 style="margin:0 0 20px 0; font-size:1.2rem; display:flex; align-items:center; gap:10px;"><i class="fas fa-chart-area" style="color:var(--primary)"></i> Histórico de Crescimento</h3>
                    <div style="position: relative; height:320px; width:100%;"><canvas id="historyChart"></canvas></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-box"><h3 style="margin:0 0 20px 0; font-size:1.1rem;">Fatia de Receita</h3><div style="position: relative; height:220px; width:100%;"><canvas id="donutChart"></canvas></div></div>
                    <div class="chart-box"><h3 style="margin:0 0 20px 0; font-size:1.1rem;">Consumo de Verba (R$)</h3><div style="position: relative; height:220px; width:100%;"><canvas id="barChart"></canvas></div></div>
                </div>
                <h3 style="margin:35px 0 20px 0; font-size:1.2rem; display:flex; align-items:center; gap:10px;"><i class="fas fa-th-large" style="color:var(--primary)"></i> Matriz Estratégica</h3>
                <div class="matrix-grid">
                    <div class="matrix-quad"><div class="matrix-title" style="color:var(--star)"><i class="fas fa-star"></i> Escalar</div><div id="quadEstrelas"></div></div>
                    <div class="matrix-quad"><div class="matrix-title" style="color:var(--primary)"><i class="fas fa-rocket"></i> Potencial</div><div id="quadApostas"></div></div>
                    <div class="matrix-quad"><div class="matrix-title" style="color:var(--warning)"><i class="fas fa-filter"></i> Gargalos</div><div id="quadGargalos"></div></div>
                    <div class="matrix-quad"><div class="matrix-title" style="color:var(--alert)"><i class="fas fa-exclamation-triangle"></i> Risco</div><div id="quadAlerta"></div></div>
                </div>
                <div class="card" style="padding:24px; border-radius:var(--radius);">
                    <h3 style="margin:0 0 20px 0; font-size:1.2rem;"><i class="fas fa-fast-forward" style="color:var(--primary)"></i> Previsão Detalhada por Cliente</h3>
                    <div style="overflow-x:auto;">
                        <table style="min-width: 800px;">
                            <thead><tr><th>Cliente</th><th>Gasto Atual</th><th>Proj. Gasto</th><th>Receita Atual</th><th>Proj. Receita</th></tr></thead>
                            <tbody id="forecastBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-section">
                <div class="settings-grid">
                    <div class="settings-box">
                        <h3><i class="fas fa-user-tie" style="color:var(--primary); margin-right:8px;"></i> Analistas</h3>
                        <div style="display:flex; gap:12px; margin-bottom:20px;">
                            <input type="text" id="newAnalystInput" class="form-input" style="margin-bottom:0;" placeholder="Nome do Analista...">
                            <button class="btn btn-primary" onclick="window.addPerson('analysts', 'newAnalystInput')">Add</button>
                        </div>
                        <div id="analystList" style="max-height:250px; overflow-y:auto; padding-right:10px;"></div>
                    </div>
                    <div class="settings-box">
                        <h3><i class="fas fa-headset" style="color:var(--primary); margin-right:8px;"></i> Consultores</h3>
                        <div style="display:flex; gap:12px; margin-bottom:20px;">
                            <input type="text" id="newConsultantInput" class="form-input" style="margin-bottom:0;" placeholder="Nome do Consultor...">
                            <button class="btn btn-primary" onclick="window.addPerson('consultants', 'newConsultantInput')">Add</button>
                        </div>
                        <div id="consultantList" style="max-height:250px; overflow-y:auto; padding-right:10px;"></div>
                    </div>
                </div>
                <div class="settings-grid">
                    <div class="settings-box">
                        <h3><i class="fas fa-download" style="color:var(--primary); margin-right:8px;"></i> Exportação de Dados</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:20px;">Baixe um arquivo CSV compatível com Excel da sua visão filtrada atual.</p>
                        <button class="btn btn-outline" style="width:100%; justify-content:center;" onclick="window.exportExcel()"><i class="fas fa-file-excel" style="color:#10b981; margin-right:8px;"></i> Gerar Relatório CSV</button>
                    </div>
                    <div class="settings-box">
                        <h3 style="color:var(--danger);"><i class="fas fa-calendar-check" style="margin-right:8px;"></i> Fechamento de Ciclo</h3>
                        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:20px;">Salva os dados do mês atual no histórico e zera os valores para iniciar um novo mês.</p>
                        <button class="btn btn-danger" style="width:100%; justify-content:center;" onclick="window.fecharMes()">Executar Virada de Mês</button>
                    </div>
                </div>
            </div>
        </main>
        
        <div class="sync-indicator" id="syncIndicator"><i class="fas fa-cloud-upload-alt"></i> Salvo na nuvem</div>
    </div>

    <div class="modal-overlay" id="crmModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h3 style="margin:0; font-size:1.2rem; font-weight:800;" id="modalClientName">Diário de Bordo</h3>
                    <div style="font-size:0.8rem; color:var(--text-muted); font-weight:600; margin-top:4px;">Registro de atividades e otimizações</div>
                </div>
                <button onclick="window.closeModal()" class="btn btn-outline btn-icon" style="border:none; background:transparent;"><i class="fas fa-times" style="font-size:1.2rem;"></i></button>
            </div>
            <div class="template-area">
                <span style="font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; display: block;"><i class="fas fa-bolt"></i> Respostas Rápidas</span>
                <div class="chip-container" id="chipContainer"></div>
            </div>
            <div class="modal-body" id="crmLogs"></div>
            <div class="modal-footer">
                <input type="text" id="crmInput" class="form-input" style="margin-bottom:0; flex:1;" placeholder="Escreva uma nova observação ou selecione um modelo acima..." onkeypress="window.handleEnter(event)">
                <button class="btn btn-primary" id="btnSaveLog" onclick="window.saveLog()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD0C2sA4pVwrHZhaoxPB_bw3e27bHK66KE",
        authDomain: "crm-marketplace-ef2aa.firebaseapp.com",
        projectId: "crm-marketplace-ef2aa",
        storageBucket: "crm-marketplace-ef2aa.firebasestorage.app",
        messagingSenderId: "174369799559",
        appId: "1:174369799559:web:d4cf0022298eced74a2722"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.appData = {
        analysts: ["Bruno Marques", "Deborah Belém", "Letícia Rodrigues", "Pedro Paulo"],
        consultants: ["Consultor Padrão", "Estrategista Sênior"],
        templates: ['Pausado anúncios com alto investimento e baixo retorno', 'Criação da campanha "XXX" com ROAS objetivo "XX"'],
        history: [],
        clients: []
    };
    
    let currentView = 'dashboard'; let currentCrmId = null; let myDonutChart = null; let myBarChart = null; let myHistoryChart = null;
    let isFirstLoad = true; 
    
    window.realizarLogin = function() {
        const e = document.getElementById('emailInput').value; const p = document.getElementById('passwordInput').value;
        const btn = document.getElementById('btnLogin'); const err = document.getElementById('loginError');
        btn.innerText = "Verificando...";
        signInWithEmailAndPassword(auth, e, p).then(() => { err.style.display = 'none'; }).catch((error) => { err.style.display = 'block'; btn.innerText = "Entrar"; });
    };

    window.fazerLogout = function() { if(confirm("Deseja realmente sair?")) { signOut(auth); } };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginScreen').style.display = 'none'; document.getElementById('appContainer').style.display = 'flex';
            iniciarTempoReal(); initAppUI();
        } else {
            document.getElementById('loginScreen').style.display = 'flex'; document.getElementById('appContainer').style.display = 'none';
        }
    });

    function iniciarTempoReal() {
        const docRef = doc(db, "crm", "master_data");
        onSnapshot(docRef, (documento) => {
            if (documento.exists()) {
                window.appData = documento.data();
                populateSelects(); window.renderAll();
                
                // Se o modal do CRM estiver aberto, atualiza as mensagens ao vivo
                if (currentCrmId !== null && document.getElementById('crmModal').classList.contains('show')) {
                    const activeClient = window.appData.clients.find(c => c.id === currentCrmId);
                    if (activeClient) window.renderLogs(activeClient.logs);
                }

                if(!isFirstLoad) {
                    const ind = document.getElementById('syncIndicator'); ind.style.display = 'flex'; setTimeout(() => ind.style.display = 'none', 2000);
                }
                isFirstLoad = false;
            } else { window.saveToFirebase(); }
        });
    }

    window.saveToFirebase = async function() {
        try { await setDoc(doc(db, "crm", "master_data"), window.appData); } catch (e) { console.error("Erro ao salvar:", e); }
    }

    // --- CORES DOS MARKETPLACES ---
    window.getMkpStyle = function(mkp) {
        if(mkp === 'Mercado Livre') return 'background-color: #ffe600; color: #2d3277;';
        if(mkp === 'Shopee') return 'background-color: #ee4d2d; color: #ffffff;';
        if(mkp === 'Amazon') return 'background-color: #000000; color: #ffffff;';
        if(mkp === 'Magalu') return 'background-color: #0086ff; color: #ffffff;';
        if(mkp === 'Leroy Merlin') return 'background-color: #78be20; color: #ffffff;';
        return 'background-color: var(--bg-body); color: var(--text-main);';
    }
    
    function initTheme() {
        const savedTheme = localStorage.getItem('rota_theme_v23');
        if(savedTheme === 'dark') document.body.classList.add('dark-mode');
        updateThemeUI();
    }
    
    window.toggleTheme = function() {
        document.body.classList.toggle('dark-mode'); localStorage.setItem('rota_theme_v23', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        updateThemeUI(); if(currentView === 'reports') renderCharts(getFilteredClients()); 
    }
    
    function updateThemeUI() {
        const isDark = document.body.classList.contains('dark-mode');
        const btn = document.getElementById('btnTheme');
        btn.innerHTML = isDark ? `<i class="fas fa-sun" style="color:#fbbf24"></i> Tema Claro` : `<i class="fas fa-moon"></i> Tema Escuro`;
        Chart.defaults.color = isDark ? '#94a3b8' : '#64748b'; Chart.defaults.borderColor = isDark ? '#1e293b' : '#e2e8f0'; Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
    }

    const today = new Date(); const day = today.getDate(); const maxDays = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const timePct = (day / maxDays) * 100;

    function parseMoney(val) {
        if (!val) return 0; let str = val.toString();
        if (str.includes(',')) str = str.replace(/\./g, '').replace(',', '.'); else if (str.includes('.')) str = str.replace(/\./g, '');
        return parseFloat(str) || 0;
    }

    function initAppUI() {
        initTheme(); document.getElementById('pacingDisplay').innerHTML = `Dia ${day} de ${maxDays} ➔ <strong style="color:var(--primary)">${timePct.toFixed(1)}% do mês</strong>`;
    }

    function getFilteredClients() {
        const cliF = document.getElementById('clientFilter').value; const anaF = document.getElementById('analystFilter').value; const conF = document.getElementById('consultantFilter').value;
        return window.appData.clients.filter(c => { return (cliF === "Todos" || c.client === cliF) && (anaF === "Todos" || c.analyst === anaF) && (conF === "Todos" || c.consultant === conF); });
    }

    window.switchTab = function(viewId, btn) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); btn.classList.add('active');
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById('view-' + viewId).classList.add('active');
        currentView = viewId; const titles = { 'dashboard': 'Visão Geral', 'reports': 'Inteligência de Dados', 'settings': 'Configurações do Sistema' };
        document.getElementById('pageTitle').innerText = titles[viewId];
        renderHeaderActions(); if(viewId==='reports') setTimeout(window.renderAll, 50); if(viewId==='settings') window.renderAll();
    };

    function renderHeaderActions() { document.getElementById('headerActions').innerHTML = currentView === 'dashboard' ? `<button class="btn btn-primary" onclick="window.addNewClient()"><i class="fas fa-plus"></i> Novo Cliente</button>` : ''; }

    window.renderAll = function() {
        if(currentView==='dashboard') renderDashboard(); if(currentView==='reports') renderReports(); if(currentView==='settings') renderSettings();
    }
    
    function populateSelects() {
        const selCli = document.getElementById('clientFilter'); const currCli = selCli.value; 
        selCli.innerHTML = '<option value="Todos">Todos os Clientes</option>';
        [...new Set(window.appData.clients.map(c => c.client))].sort().forEach(c => selCli.innerHTML += `<option value="${c}">${c}</option>`);
        selCli.value = currCli || "Todos";

        const selAna = document.getElementById('analystFilter'); const currAna = selAna.value; 
        selAna.innerHTML = '<option value="Todos">Todos os Analistas</option>';
        window.appData.analysts.forEach(a => selAna.innerHTML += `<option value="${a}">${a}</option>`);
        selAna.value = currAna || "Todos";

        const selCon = document.getElementById('consultantFilter'); const currCon = selCon.value;
        selCon.innerHTML = '<option value="Todos">Todos os Consultores</option>';
        window.appData.consultants.forEach(a => selCon.innerHTML += `<option value="${a}">${a}</option>`);
        selCon.value = currCon || "Todos";
    }

    function renderDashboard() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const filtered = getFilteredClients();

        filtered.forEach(item => {
            const index = window.appData.clients.findIndex(c => c.id === item.id);
            const vt = item.verbaType || 'R$';
            const v = parseFloat(item.verba)||0, ma = parseFloat(item.metaAcos)||0, g = parseFloat(item.gasto)||0, r = parseFloat(item.receita)||0;
            const acos = r > 0 ? ((g/r)*100) : 0;
            
            const mkp = item.marketplace || 'Mercado Livre';
            const mkpStyle = window.getMkpStyle(mkp);
            const mkpOptions = ["Mercado Livre", "Shopee", "Amazon", "Magalu", "Leroy Merlin"].map(m => `<option value="${m}" style="background:var(--bg-card); color:var(--text-main);" ${mkp===m?'selected':''}>${m}</option>`).join('');

            let statVerba = '';
            if (vt === 'R$') {
                const pu = v > 0 ? (g/v)*100 : 0; let c = "text-green"; if(pu>timePct) c="text-red"; else if(pu<(timePct-20)) c="text-orange";
                statVerba = `<span class="usage-badge ${c}">${pu.toFixed(1)}%</span>`;
            } else {
                let c = "text-green"; if(acos>v) c="text-red";
                statVerba = `<span class="usage-badge ${c}">${vt}</span>`;
            }
            
            let statP = {t:"PLATÔ", c:"bg-plato"};
            if(item.progress>3) statP={t:"SUBINDO", c:"bg-subindo"}; else if(item.progress<-3) statP={t:"CAINDO", c:"bg-caindo"};

            let oAna = window.appData.analysts.map(a => `<option value="${a}" ${item.analyst===a?'selected':''}>${a}</option>`).join('');
            let oCon = window.appData.consultants.map(a => `<option value="${a}" ${item.consultant===a?'selected':''}>${a}</option>`).join('');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><select class="smart-input" style="${mkpStyle} border:none; text-align:center; font-weight:800;" onchange="window.upd(${index},'marketplace',this.value)">${mkpOptions}</select></td>
                <td><input class="smart-input" style="font-weight:800; font-size:0.95rem; color:var(--text-main);" value="${item.client}" onchange="window.upd(${index},'client',this.value)"></td>
                <td><select class="smart-input" onchange="window.upd(${index},'analyst',this.value)">${oAna}</select></td>
                <td><select class="smart-input" onchange="window.upd(${index},'consultant',this.value)">${oCon}</select></td>
                <td><div style="display:flex; gap:8px; align-items:center;"><select class="smart-input" style="width:90px; padding:6px; font-weight:700;" onchange="window.upd(${index},'verbaType',this.value)"><option value="R$" ${vt==='R$'?'selected':''}>R$</option><option value="ACOS" ${vt==='ACOS'?'selected':''}>ACOS</option><option value="TACOS" ${vt==='TACOS'?'selected':''}>TACOS</option></select><input type="text" class="smart-input" style="flex:1; font-weight:700;" value="${v}" onchange="window.upd(${index},'verba',this.value)"></div></td>
                <td><input type="text" class="smart-input" style="font-weight:600;" value="${g}" onchange="window.upd(${index},'gasto',this.value)"></td>
                <td><input type="text" class="smart-input" style="font-weight:600;" value="${r}" onchange="window.upd(${index},'receita',this.value)"></td>
                <td style="text-align:center;"><input type="text" class="smart-input" style="text-align:center; font-weight:700; color:var(--text-muted);" value="${ma}" onchange="window.upd(${index},'metaAcos',this.value)"></td>
                <td style="text-align:center;"><span class="usage-badge text-primary-badge">${acos.toFixed(1)}%</span></td>
                <td style="text-align:center;">${statVerba}</td>
                <td style="text-align:center;"><input type="number" class="smart-input" style="text-align:center; font-weight:800;" value="${item.progress}" onchange="window.upd(${index},'progress',this.value)"></td>
                <td style="text-align:center;"><span class="status-badge ${statP.c}">${statP.t}</span></td>
                <td style="text-align:right; white-space:nowrap;"><button class="btn btn-outline btn-icon" title="Diário de Bordo" onclick="window.openCrm(${item.id})"><i class="fas fa-comment-dots" style="${item.logs.length?'color:var(--primary)':''}"></i></button> <button class="btn btn-outline btn-icon" style="color:var(--danger);" title="Excluir" onclick="window.del(${index})"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        });
        renderHeaderActions();
    }

    function calcMoM(current, past, inverted = false) {
        if(!past || past === 0) return '';
        const diff = ((current - past) / past) * 100;
        const isGood = inverted ? diff <= 0 : diff >= 0; 
        const arrow = diff >= 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
        return `<span class="mom-indicator ${isGood ? 'mom-up' : 'mom-down'}">${arrow} ${Math.abs(diff).toFixed(1)}% vs. Último Mês</span>`;
    }

    function renderReports() {
        const filtered = getFilteredClients();
        const isFiltered = document.getElementById('clientFilter').value !== 'Todos' || document.getElementById('analystFilter').value !== 'Todos' || document.getElementById('consultantFilter').value !== 'Todos';
        document.getElementById('biFilterWarning').style.display = isFiltered ? 'inline-flex' : 'none';

        const sum = (f) => filtered.reduce((a, c) => a + (parseFloat(c[f])||0), 0);
        const tGasto = sum('gasto'), tReceita = sum('receita');
        const gAcos = tReceita > 0 ? (tGasto/tReceita)*100 : 0;
        const lastMonth = window.appData.history.length > 0 ? window.appData.history[window.appData.history.length - 1] : {gasto:0, receita:0, acos:0};

        document.getElementById('kpiGasto').innerText = tGasto.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('kpiReceita').innerText = tReceita.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('kpiAcos').innerText = gAcos.toFixed(1) + "%";
        
        if (isFiltered) {
            const warn = `<div class="mom-hidden">Análise de histórico ocultada.</div>`;
            document.getElementById('momGasto').innerHTML = warn; document.getElementById('momReceita').innerHTML = warn; document.getElementById('momAcos').innerHTML = warn;
        } else {
            document.getElementById('momGasto').innerHTML = calcMoM(tGasto, lastMonth.gasto, false);
            document.getElementById('momReceita').innerHTML = calcMoM(tReceita, lastMonth.receita, false);
            document.getElementById('momAcos').innerHTML = calcMoM(gAcos, lastMonth.acos, true);
        }

        document.getElementById('kpiProjReceita').innerText = (day > 0 ? (tReceita / day) * maxDays : 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

        const fb = document.getElementById('forecastBody'); fb.innerHTML = '';
        filtered.forEach(c => {
            const g=parseFloat(c.gasto)||0, r=parseFloat(c.receita)||0; if(g===0 && r===0) return;
            fb.innerHTML += `<tr><td><strong style="color:var(--text-main)">${c.client}</strong></td><td>R$ ${g.toLocaleString('pt-BR')}</td><td style="color:var(--warning); font-weight:700;">R$ ${(day>0?(g/day)*maxDays:0).toLocaleString('pt-BR',{maximumFractionDigits:0})}</td><td>R$ ${r.toLocaleString('pt-BR')}</td><td style="color:var(--success); font-weight:700;">R$ ${(day>0?(r/day)*maxDays:0).toLocaleString('pt-BR',{maximumFractionDigits:0})}</td></tr>`;
        });

        const avgReceita = filtered.length > 0 ? tReceita / filtered.length : 0;
        let qEst = '', qApo = '', qGar = '', qAle = '';
        filtered.forEach(c => {
            const r=parseFloat(c.receita)||0, g=parseFloat(c.gasto)||0, ma=parseFloat(c.metaAcos)||0, acos = r>0 ? (g/r)*100 : 0;
            const isAcosGood = ma > 0 ? acos <= ma : true; const isRevHigh = r >= avgReceita;
            const tag = `<div class="client-tag ${isRevHigh && isAcosGood ? 'tag-estrela' : (!isRevHigh && isAcosGood ? 'tag-aposta' : (isRevHigh && !isAcosGood ? 'tag-gargalo' : 'tag-alerta'))}"><span style="color:var(--text-main)">${c.client}</span><span style="color:var(--text-muted)">ACOS: ${acos.toFixed(1)}%</span></div>`;
            if(isRevHigh && isAcosGood) qEst += tag; else if(!isRevHigh && isAcosGood) qApo += tag; else if(isRevHigh && !isAcosGood) qGar += tag; else qAle += tag;
        });
        document.getElementById('quadEstrelas').innerHTML = qEst || '<div style="font-size:0.85rem; color:var(--text-muted); padding:10px 0;">Nenhum cliente.</div>';
        document.getElementById('quadApostas').innerHTML = qApo || '<div style="font-size:0.85rem; color:var(--text-muted); padding:10px 0;">Nenhum cliente.</div>';
        document.getElementById('quadGargalos').innerHTML = qGar || '<div style="font-size:0.85rem; color:var(--text-muted); padding:10px 0;">Nenhum cliente.</div>';
        document.getElementById('quadAlerta').innerHTML = qAle || '<div style="font-size:0.85rem; color:var(--text-muted); padding:10px 0;">Nenhum cliente.</div>';

        renderCharts(filtered, tGasto, tReceita, isFiltered);
    }

    function renderCharts(filteredClients, currentGasto, currentReceita, isFiltered) {
        if (myDonutChart) myDonutChart.destroy(); if (myBarChart) myBarChart.destroy(); if (myHistoryChart) myHistoryChart.destroy();
        const isDark = document.body.classList.contains('dark-mode'); const gridColor = isDark ? '#1e293b' : '#f1f5f9';

        let labels = [], dataR = [], dataG = [];
        if (!isFiltered) {
            labels = window.appData.history.map(h => h.month); dataR = window.appData.history.map(h => h.receita); dataG = window.appData.history.map(h => h.gasto);
            labels.push("Mês Atual"); dataR.push(currentReceita); dataG.push(currentGasto);
        } else {
            labels = ["Mês Atual (Visão Filtrada)"]; dataR = [currentReceita]; dataG = [currentGasto];
        }

        myHistoryChart = new Chart(document.getElementById('historyChart').getContext('2d'), {
            type: 'line', data: { labels: labels, datasets: [
                { label: 'Receita', data: dataR, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, borderWidth: 3, pointRadius: 4 },
                { label: 'Gasto', data: dataG, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.05)', fill: true, tension: 0.4, borderWidth: 3, pointRadius: 4 }
            ]}, options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: gridColor, drawBorder: false } }, y: { grid: { color: gridColor, drawBorder: false } } } }
        });

        let revByAnalyst = {}; filteredClients.forEach(c => { revByAnalyst[c.analyst] = (revByAnalyst[c.analyst] || 0) + (parseFloat(c.receita)||0); });
        myDonutChart = new Chart(document.getElementById('donutChart').getContext('2d'), {
            type: 'doughnut', data: { labels: Object.keys(revByAnalyst), datasets: [{ data: Object.values(revByAnalyst), backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: isDark ? 2 : 0, borderColor: isDark ? '#0f172a' : '#fff' }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: {size: 12} } } } }
        });

        const brClients = filteredClients.filter(c => c.verbaType === 'R$');
        myBarChart = new Chart(document.getElementById('barChart').getContext('2d'), {
            type: 'bar', data: { labels: brClients.map(c => c.client.substring(0,12)), datasets: [
                { label: 'Gasto', data: brClients.map(c => parseFloat(c.gasto)||0), backgroundColor: '#4f46e5', borderRadius: 4 },
                { label: 'Verba', data: brClients.map(c => parseFloat(c.verba)||0), backgroundColor: isDark ? '#1e293b' : '#e2e8f0', borderRadius: 4 }
            ]}, options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { color: gridColor, drawBorder: false } } } }
        });
    }

    function renderSettings() {
        const renderList = (arr, elId, key) => {
            const l = document.getElementById(elId); l.innerHTML = '';
            arr.forEach((a,i) => l.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px 10px; border-bottom:1px solid var(--border);">
                <span style="font-weight:600;">${a}</span><button class="btn btn-outline btn-icon" style="padding:6px; color:var(--danger);" onclick="window.remPerson('${key}',${i})"><i class="fas fa-trash"></i></button></div>`);
        };
        renderList(window.appData.analysts, 'analystList', 'analysts');
        renderList(window.appData.consultants, 'consultantList', 'consultants');
    }

    window.upd = function(idx, field, val) {
        if(['verba','gasto','receita','metaAcos'].includes(field)) window.appData.clients[idx][field] = parseMoney(val);
        else if(field === 'progress') window.appData.clients[idx][field] = parseFloat(val)||0;
        else window.appData.clients[idx][field] = val;
        window.saveToFirebase();
    }
    
    window.addNewClient = function() {
        const ana = document.getElementById('analystFilter').value; const con = document.getElementById('consultantFilter').value;
        window.appData.clients.unshift({ id: Date.now(), marketplace: "Mercado Livre", client: "Novo Cliente", analyst: ana==="Todos"?window.appData.analysts[0]:ana, consultant: con==="Todos"?window.appData.consultants[0]:con, verbaType: "R$", verba: 0, metaAcos: 0, gasto: 0, receita: 0, progress: 0, logs: [] });
        window.saveToFirebase();
    }
    
    window.del = function(i) { if(confirm("Excluir este cliente?")) { window.appData.clients.splice(i,1); window.saveToFirebase(); } }
    
    window.addPerson = function(arrKey, inputId) {
        const n = document.getElementById(inputId).value;
        if(n) { window.appData[arrKey].push(n); document.getElementById(inputId).value=''; window.saveToFirebase(); }
    }
    window.remPerson = function(arrKey, i) { if(confirm("Remover profissional?")) { window.appData[arrKey].splice(i,1); window.saveToFirebase(); } }
    
    window.fecharMes = function() { 
        const monthName = prompt("Mês do fechamento? (Ex: Mar/2026)", "Mar/2026");
        if(!monthName) return;
        if(confirm(`⚠️ ATENÇÃO: Deseja fechar ${monthName}?\nOs totais globais serão salvos no histórico e os gastos/receitas atuais zerados para todos.`)) { 
            const tGasto = window.appData.clients.reduce((a, c) => a + (parseFloat(c.gasto)||0), 0);
            const tRec = window.appData.clients.reduce((a, c) => a + (parseFloat(c.receita)||0), 0);
            const acos = tRec > 0 ? (tGasto/tRec)*100 : 0;
            window.appData.history.push({ month: monthName, gasto: tGasto, receita: tRec, acos: acos });
            window.appData.clients.forEach(c => {c.gasto=0; c.receita=0;}); 
            window.saveToFirebase(); alert(`✅ Fechamento concluído!`); 
        } 
    }

    window.exportExcel = function() {
        let csv = "\uFEFFMarketplace;Cliente;Analista;Consultor;Tipo Verba;Verba;Gasto;Receita;Meta ACOS;ACOS Atual;Progresso\n";
        getFilteredClients().forEach(c => {
            const fmt = n => (parseFloat(n)||0).toFixed(2).replace('.',',');
            const vt = c.verbaType || 'R$';
            const v=parseFloat(c.verba)||0, g=parseFloat(c.gasto)||0, r=parseFloat(c.receita)||0, ma=parseFloat(c.metaAcos)||0;
            const ac = r>0?((g/r)*100).toFixed(1):"0.0";
            const mkp = c.marketplace || 'Mercado Livre';
            csv += `"${mkp}";"${c.client}";"${c.analyst}";"${c.consultant || ''}";"${vt}";"${fmt(v)}";"${fmt(g)}";"${fmt(r)}";"${fmt(ma)}%";"${ac.replace('.',',')}%";"${fmt(c.progress)}"\n`;
        });
        const b = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = `Rota_CRM_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.csv`;
        document.body.appendChild(l); l.click(); document.body.removeChild(l);
    }

    // --- NOVA LÓGICA DO DIÁRIO DE BORDO ---
    window.openCrm = function(id) {
        currentCrmId = id; const client = window.appData.clients.find(c => c.id===id);
        document.getElementById('modalClientName').innerText = `Diário: ${client.client}`;
        const overlay = document.getElementById('crmModal'); overlay.style.display = 'flex'; setTimeout(() => overlay.classList.add('show'), 10);
        renderTemplates(); window.renderLogs(client.logs); setTimeout(()=>document.getElementById('crmInput').focus(), 300);
    }
    
    function renderTemplates() {
        const c = document.getElementById('chipContainer'); c.innerHTML = '';
        window.appData.templates.forEach((t, i) => { c.innerHTML += `<div class="chip" title="${t.replace(/"/g, '&quot;')}" onclick="window.useTemplate(${i})">${t.length > 40 ? t.substring(0, 40) + '...' : t}</div>`; });
        c.innerHTML += `<div class="chip chip-add" onclick="window.addNewTemplate()"><i class="fas fa-plus"></i> Novo Modelo</div>`;
    }
    window.addNewTemplate = function() { const t = prompt("Novo modelo:"); if(t && t.trim() !== '') { window.appData.templates.push(t.trim()); window.saveToFirebase(); renderTemplates(); } }
    
    // Agora separa Fixados de Normais
    window.renderLogs = function(lgs) {
        const d = document.getElementById('crmLogs'); d.innerHTML = '';
        if(!lgs || lgs.length === 0) { d.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:40px 20px; font-weight:600;"><i class="fas fa-folder-open" style="font-size:2rem; margin-bottom:10px; opacity:0.5;"></i><br>Nenhum registro encontrado.</div>'; return; }
        
        let mapped = lgs.map((log, i) => ({...log, originalIndex: i}));
        let pinned = mapped.filter(l => l.pinned).reverse();
        let unpinned = mapped.filter(l => !l.pinned).reverse();

        const buildHtml = (lista, isPinned) => {
            lista.forEach(l => {
                const pinBg = isPinned ? 'background: var(--warning-light); border: 1px solid #fcd34d;' : 'background: var(--bg-card); border: 1px solid var(--border);';
                const pinColor = isPinned ? 'color: var(--warning);' : 'color: var(--text-muted);';
                
                d.innerHTML += `
                <div class="log-entry" style="${pinBg}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; border-bottom:1px solid rgba(0,0,0,0.05); padding-bottom:12px;">
                        <div>
                            <span style="font-weight:800; color:var(--primary); font-size:0.95rem;"><i class="fas fa-user-circle" style="margin-right:6px;"></i>${l.user}</span>
                            ${isPinned ? '<span style="margin-left:8px; font-size:0.7rem; background:var(--warning); color:#fff; padding:2px 6px; border-radius:4px; font-weight:800;"><i class="fas fa-thumbtack"></i> FIXADO</span>' : ''}
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:0.75rem; color:var(--text-muted); font-weight:600;">${l.date}</span>
                            <button class="log-action-btn" onclick="window.editLog(${l.originalIndex})" title="Editar Mensagem"><i class="fas fa-edit"></i></button>
                            <button class="log-action-btn" onclick="window.togglePinLog(${l.originalIndex})" style="${pinColor}" title="Fixar/Desfixar no Topo"><i class="fas fa-thumbtack"></i></button>
                        </div>
                    </div>
                    <div style="color:var(--text-main); font-size:0.95rem; line-height:1.5; font-weight:500;">${l.msg}</div>
                </div>`;
            });
        };

        buildHtml(pinned, true);
        buildHtml(unpinned, false);
    }
    
    // Funções de Edição e Fixação
    window.editLog = function(index) {
        const client = window.appData.clients.find(x => x.id === currentCrmId);
        const currentMsg = client.logs[index].msg;
        const newMsg = prompt("Edite sua mensagem abaixo:", currentMsg);
        
        if (newMsg !== null && newMsg.trim() !== '') {
            client.logs[index].msg = newMsg.trim();
            window.saveToFirebase();
            window.renderLogs(client.logs);
        }
    }

    window.togglePinLog = function(index) {
        const client = window.appData.clients.find(x => x.id === currentCrmId);
        client.logs[index].pinned = !client.logs[index].pinned;
        window.saveToFirebase();
        window.renderLogs(client.logs);
    }

    window.useTemplate = function(i) { document.getElementById('crmInput').value = window.appData.templates[i]; document.getElementById('crmInput').focus(); }
    window.saveLog = function() {
        const t = document.getElementById('crmInput').value.trim(); if(!t) return;
        const anaF = document.getElementById('analystFilter').value; const u = anaF === "Todos" ? "Equipe" : anaF.split(' ')[0];
        const c = window.appData.clients.find(x => x.id===currentCrmId);
        c.logs.push({date: new Date().toLocaleDateString('pt-BR')+' às '+new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}), user: u, msg: t, pinned: false});
        document.getElementById('crmInput').value=''; window.saveToFirebase(); window.renderLogs(c.logs);
    }
    
    window.closeModal = function() { const overlay = document.getElementById('crmModal'); overlay.classList.remove('show'); setTimeout(() => overlay.style.display='none', 300); currentCrmId = null; }
    window.handleEnter = function(e) { if(e.key === 'Enter') window.saveLog(); }

</script>

<script>
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
    }
</script>

</body>
</html>